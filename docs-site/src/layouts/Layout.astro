---
import '../styles/global.css'

interface Props {
  title: string
  description: string
  locale: string
  keywords?: string
}

const { title, description, locale, keywords } = Astro.props
const canonicalURL = new URL(Astro.url.pathname, Astro.site)
const ogImage = `${Astro.site}og-image.png`
const base = '/prisma-to-sql'

const rtlLocales = new Set(['ar', 'ur'])
const dir = rtlLocales.has(locale) ? 'rtl' : 'ltr'

const locales = ['en', 'es', 'fr', 'pt', 'hi', 'bn', 'ar', 'ur', 'ru', 'zh']

const normalizeBase = (p: string) => {
  if (p === base) return `${base}/`
  return p
}

const stripLocaleFromPath = (pathname: string) => {
  const path = normalizeBase(pathname)
  if (!path.startsWith(`${base}/`)) return path

  const afterBase = path.slice(`${base}/`.length)
  const firstSeg = afterBase.split('/')[0]

  if (locales.includes(firstSeg)) {
    const rest = afterBase.slice(firstSeg.length)
    return `${base}${rest || '/'}`
  }

  return path
}

const pathWithoutLocale = stripLocaleFromPath(Astro.url.pathname)

const makeLocalizedPath = (code: string) => {
  if (code === 'en') return pathWithoutLocale
  const rest = pathWithoutLocale.slice(base.length)
  return `${base}/${code}${rest}`
}

const alternateLinks = locales.map((code) => ({
  code,
  href: new URL(makeLocalizedPath(code), Astro.site).toString()
}))

const xDefault = alternateLinks.find((x) => x.code === 'en')?.href
---

<!doctype html>
<html lang={locale} dir={dir}>
  <head>
    <meta charset='UTF-8' />
    <meta
      name='viewport'
      content='width=device-width, initial-scale=1.0, maximum-scale=5.0'
    />
    <meta
      http-equiv='Content-Security-Policy'
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; base-uri 'self'; form-action 'self';"
    />
    <meta
      http-equiv='Referrer-Policy'
      content='strict-origin-when-cross-origin'
    />

    <title>{title}</title>
    <meta name='title' content={title} />
    <meta name='description' content={description} />
    {keywords && <meta name='keywords' content={keywords} />}
    <meta name='author' content='multipliedtwice' />
    <meta name='robots' content='index, follow' />

    <link rel='canonical' href={canonicalURL} />

    {alternateLinks.map((l) => (
      <link rel="alternate" hreflang={l.code} href={l.href} />
    ))}
    {xDefault && <link rel="alternate" hreflang="x-default" href={xDefault} />}

    <link rel='preconnect' href='https://cdnjs.cloudflare.com' crossorigin />
    <link rel='dns-prefetch' href='https://cdnjs.cloudflare.com' />

    <meta property='og:type' content='website' />
    <meta property='og:url' content={canonicalURL} />
    <meta property='og:title' content={title} />
    <meta property='og:description' content={description} />
    <meta property='og:image' content={ogImage} />

    <meta property='twitter:card' content='summary_large_image' />
    <meta property='twitter:url' content={canonicalURL} />
    <meta property='twitter:title' content={title} />
    <meta property='twitter:description' content={description} />
    <meta property='twitter:image' content={ogImage} />

    <link rel='icon' type='image/x-icon' href={`${base}/favicon.ico`} />
    <link rel='icon' type='image/svg+xml' href={`${base}/favicon.svg`} />
    <link
      rel='icon'
      type='image/png'
      sizes='16x16'
      href={`${base}/favicon-16x16.png`}
    />
    <link
      rel='icon'
      type='image/png'
      sizes='32x32'
      href={`${base}/favicon-32x32.png`}
    />
    <link
      rel='icon'
      type='image/png'
      sizes='96x96'
      href={`${base}/favicon-96x96.png`}
    />
    <link
      rel='apple-touch-icon'
      sizes='180x180'
      href={`${base}/apple-touch-icon.png`}
    />
    <link rel='manifest' href={`${base}/site.webmanifest`} />
    <meta name="yandex-verification" content="40059b1c63420216" />

    <slot name='head' />
  </head>
  <body class='bg-gray-50'>
    <main>
      <slot />
    </main>

    <script
      is:inline
      src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js'
      async></script>
    <script is:inline>
      if ('loading' in HTMLScriptElement.prototype) {
        document.addEventListener('DOMContentLoaded', function () {
          if (typeof hljs !== 'undefined') {
            hljs.highlightAll()
          }
        })
      } else {
        window.addEventListener('load', function () {
          if (typeof hljs !== 'undefined') {
            hljs.highlightAll()
          }
        })
      }
    </script>
  </body>
</html>
